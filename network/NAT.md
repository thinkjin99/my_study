### 출처
* https://velog.io/@yange/NAT%EC%99%80-PAT%EC%97%90-%EB%8C%80%ED%95%98%EC%97%AC (PAT)
* https://www.learnaws.org/2022/06/30/internet-vs-nat-gateway/ (ec2 NAT)
* https://martinkim1954.tistory.com/entry/AWS-%EC%9D%B8%ED%84%B0%EB%84%B7%EA%B2%8C%EC%9D%B4%ED%8A%B8%EC%9B%A8%EC%9D%B4Internet-Gateway-%EC%83%9D%EC%84%B1-%EB%B0%8F-%EB%9D%BC%EC%9A%B0%ED%8C%85 (ec2 NAT 한글)
* https://dev.classmethod.jp/articles/amazon-vpc-eni-deep-dive/ (ENI)
___
### 개요
* [[#NAT란]]
* [[#NAT의 동작 방식]]
* [[#EC2와 NAT]]
* [[#EC2 소켓 바인딩 에러]]
___
### NAT란

Network Address Translation은 **사설 네트워크에 속한 여러 호스트가 한개의 공인 IP를 활용해 인터넷을 사용하기 위해 필요한 기술**이다. <span class="red red-bg">NAT는 IP 부족 현상을 해결하기 위한 방법으로 탄생했으며 주 목적은 사설 IP를 공인 IP로 변환하는 것이다.</span>

**사설망 내부에 존재하는 호스트들은 외부 망으로 나가는 것까지는 가능하더라도 외부망의 호스트가 사설주소를 보고 적절히 패킷을 전달하는 것이 불가능하기 때문에 응답을 전달 받을 수 없다**. 실제로 AWS에서 Private VPC를 사용해보면 NAT가 없을 경우 VPC 내부 인스턴스가 인터넷의 응답을 수신하지 못하는 것을 확인 할 수 있다. (람다의 경우도 Private VPC에 속하면 인터넷이 안된다. 람다는 IP를 가질 수 없기 때문에)

**따라서 NAT를 사용해 사설 주소 -> 공인 주소,  공인주소 -> 사설 주소로의 전환이 가능하게 해줘야 사설 망 내부에서도 인터넷 활용이 가능하다.**
___
### NAT의 동작 방식

* **Static NAT**
	하나의 사설 IP 주소를 하나의 공인 IP 주소에 정적으로 매핑한다. 해당 사설 IP는 무조건 대응하는 공인 IP로 치환된다. 공인 IP를 많이 확보해야해서 경제적이진 않은 방법이다.

*  **PAT (Port Address Translation)**
	**포트 번호를 활용해 사설 IP를 구분하는 방식이다**. 다수의 사설 IP가 하나의 공인 IP에 대응되고 이때 각 커넥션을 포트 번호를 활용해 구분한다. 예를 들어 공인 ip가 223.28.3.1일때 사설 ip가 3개 존재하면 223.28.3.1:10,223.28.3.1:20,223.28.3.1:30 등으로 포트를 다르게 활용해 통신을 진행한다.
	요즘 공유기는 대다수가 이 방법을 사용한다.
	**NAT는 이러한 기능을 제공하기 위해서 송,수신되는 데이터 패킷의 IP와 포트 번호를 수정할 수 있어야 하고 변환을 알맞게 하기 위한 테이블을 보유해야 한다.**

![](https://obs3dian.s3.ap-northeast-2.amazonaws.com/NAT%20/%20Pasted%20image%2020231222172040.png)

____
### EC2와 NAT

ec2를 사용하다보면 재부팅을 진행할 때마다 새로운 퍼블릭 ip를 할당 받는 현상을 확인해 본적이 있을 것이다. 이러한 현상이 발생하는 이유는 ENI 때문으로 EC2는 ENI라 불리는 가상 네트워크 인터페이스를 활용해 네트워크 연결을 진행한다. 

**ENI는 가상이긴 하지만 네트워크 인터페이스이기에 ip주소와 MAC주소를 소유하고 있다. ENI는 보안 그룹 내부에 존재하며 하나의 서브넷에 연결된다. 서브넷은 하나의 VPC 내부에 존재하게 되고 VPC 내부 인스턴스들은 모두 각각의 프라이빗 IP를 할당 받게 된다.** 

정리하면 ec2 인스턴스는 특정 VPC 내부에 특정 서브넷에 위치하고 어떠한 ENI에 연결된 상태이다. 이미지로 나타내면 아래와 같다.

![https://dev.classmethod.jp/articles/amazon-vpc-eni-deep-dive/|500](https://obs3dian.s3.ap-northeast-2.amazonaws.com/NAT%20/%20%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202024-06-07%20%EC%98%A4%ED%9B%84%209.47.36.png)


이러한 상황에서 EC2가 송신을 진행하고 싶다면 ENI를 타고 인터넷 게이트웨이로 나가 송신을 진행해야 한다. 데이터를 수신하기 위해선 게이트웨이로 들어온 데이터가 적절한 서브넷으로 전달돼야 한다. 이를 위해 라우팅 테이블을 만들어 네트워크 데이터를 알맞은 서브넷으로 전달한다. 

여기서 주의해야할 점이 하나 있는데 <span class="red red-bg">퍼블릭 서브넷에 위치한 인스턴스는 자신의 퍼블릭 IP 주소를 알지 못하고 VPC 내부의 프라이빗 주소만 파악한다는 것이다. 이에 따라 퍼블릭 서브넷에 위치하고 퍼블릭 IP를 보유하고 있더라도 곧장 통신을 진행할 수는 없다.</span> AWS에서는 VPC 내부에 위치한 인스턴스들은 전부 프라이빗  IP를 활용해 통신을 진행한다.

==**따라서 인터넷 게이트웨이가 VPC 내부의 프라이빗 주소를 인스턴스의 공개 주소로 변환해 통신하는 작업을 수행한다**==. (NAT 작업을 수행)

>  _**사용자의 인스턴스는 VPC 및 서브넷 내부에서 정의된 프라이빗(내부) IP 주소 공간만 인식합니다**_. 인터넷 게이트웨이는 _**사용자의 인스턴스를 대신하여 논리적으로 일대일 NAT를 제공하므로**, 트래픽이 VPC 서브넷을 떠나 인터넷으로 이동할 때 회신 주소 필드는 프라이빗 IP 주소가 아니라, 인스턴스의 퍼블릭 IPv4 주소 또는 탄력적 IP 주소(EIP)로 설정됩니다_. 반대로, _인스턴스의 퍼블릭 IPv4 주소 또는 탄력적 IP 주소를 대상 주소로 하는 트래픽에는 트래픽이 VPC로 전달되기 전에 인스턴스의 프라이빗 IPv4 주소로 변환되는 대상 주소가 있습니다._ [출처](https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/VPC_Internet_Gateway.html)

____
### EC2 소켓 바인딩 에러

[[초 간단 웹서버 만들고 실험하기]] 에서 발생한 문제로 생성한 웹 서버를 EC2에 배포하는 과정에서 이슈가 발생했다. 이슈 내용은 단순한데 클라우드 환경에서 서버를 실행하면 다음과 같은 문제가 발생했다.

`socket_bind bind can't assign requested address` 바인딩 하는 주소를 EC2에 퍼블릭 주소로 설정 했을 때 위와 같은 이슈가 발생했다. 문제는 초기에는 미궁이었다. 파이썬 코드 문제도 의심하고 보안 그룹 문제도 의심했다. 하지만 ip 주소를 `0.0.0.0`으로 바인딩을 진행한 후에는 정상적으로 코드가 동작하는 것을 확인했다.

왜 공개 ip를 인식하질 못하지? 위의 내용을 학습하기 전까지 문제는 정말 미궁이였다. 문제는 앞서 말했듯 **VPC 내부의 인스턴스는 자신의 퍼블릭 IP를 인식하지 못한다는 것이였고 프라이빗 IP로 바인딩 주소를 바꿔 이슈를 해결할 수 있었다.**

#### 근데 왜 VPC 내부의 인스턴스는 퍼블릭 ip를 알지 못할까?
퍼블릭 ip를 갖고 있더라도 인터넷 게이트웨이를 통과해야 하는 이유는 **비용 측정과 관련이 있지 않을까 싶다.** AWS의 경우 VPC 내부의 트래픽과 외부의 트래픽에 따른 가격 측정을 진행해야 하기 때문에 별도의 인터넷 게이트웨이를 통과해 통신을 진행하게 한다.
